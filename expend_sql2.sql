DROP TABLE ITEM;

DROP TABLE ITEM_SUM;

CREATE TABLE ITEM
AS
    SELECT 'A' ITEM, 1 SEQ, 100 QTY, '20181101' YMD FROM DUAL UNION ALL
    SELECT 'A' ITEM, 2 SEQ, 200 QTY, '20181101' YMD FROM DUAL UNION ALL
    SELECT 'A' ITEM, 3 SEQ, 150 QTY, '20181102' YMD FROM DUAL UNION ALL
    SELECT 'B' ITEM, 1 SEQ, 100 QTY, '20181102' YMD FROM DUAL UNION ALL
    SELECT 'B' ITEM, 2 SEQ, 120 QTY, '20181102' YMD FROM DUAL UNION ALL
    SELECT 'B' ITEM, 3 SEQ, 200 QTY, '20181102' YMD FROM DUAL UNION ALL
    SELECT 'D' ITEM, 1 SEQ, 100 QTY, '20181103' YMD FROM DUAL UNION ALL
    SELECT 'D' ITEM, 2 SEQ, 200 QTY, '20181103' YMD FROM DUAL UNION ALL
    SELECT 'D' ITEM, 3 SEQ, 200 QTY, '20181103' YMD FROM DUAL
;

CREATE TABLE ITEM_SUM
AS
    SELECT 'A' ITEM, 250 QTY, '20181101' YMD FROM DUAL UNION ALL
    SELECT 'A' ITEM, 200 QTY, '20181102' YMD FROM DUAL UNION ALL
    SELECT 'C' ITEM, 300 QTY, '20181101' YMD FROM DUAL UNION ALL
    SELECT 'D' ITEM, 600 QTY, '20181101' YMD FROM DUAL
;    

SELECT 
    MIN(DECODE(NO,1,ITEM)) ITEM,
    MIN(DECODE(NO,1,'TOT',SEQ)) SEQ,
    SUM(DECODE(SW,0,QTY)) QTY1,
    SUM(DECODE(SW,2,QTY)) QTY2,
    SUM((1-SW)*DECODE(NO,1,QTY)) DIFF
FROM 
    (
        SELECT /*+ OPT_PARAM('_gby_hash_aggregation_enabled' 'false') */  -- hash group by를 사용하는 경우 order by 순서가 보장되지 않아서 hint사용으로 sort group by가 되도록 함
               ITEM, NO, DECODE(NO,1,'TOT',SEQ) SEQ, SUM(QTY) QTY, 0 SW
        FROM   (SELECT ITEM, SEQ, QTY FROM ITEM WHERE YMD LIKE '201811%') A,
               (SELECT LEVEL NO FROM DUAL CONNECT BY LEVEL <= 2)
        GROUP BY ITEM, NO, DECODE(NO,1,'TOT',SEQ)
        UNION ALL
        SELECT 
               ITEM, 1 NO, 'TOT' SEQ, QTY, 2 SW
        FROM   ITEM_SUM S
        WHERE  YMD LIKE '201811%'
    )
GROUP BY ITEM, NO, SEQ 
;